<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Global Talent Map ‚Äî Winkel Tripel (OpenLayers)</title>
  <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A">

  <!-- proj4 (keep this above OpenLayers) -->
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.0/dist/proj4.js"></script>

  <!-- OpenLayers hosted build (official) -->
  <script src="https://cdn.jsdelivr.net/npm/ol@v10.6.1/dist/ol.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.6.1/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    :root{
      --cream-bg:#F8F6F1; --cream-light:#FDFBF7;
      --navy-primary:#1d333e; --navy-secondary:#2C4A5A; --light-navy:#4A6B7A;
      --accent-blue:#2B74B3; --accent-blue-light:#6BA7D6;
      --warm-white:#FFFFFF; --soft-gray:#F8F9FA;
      --border-light:rgba(29,51,62,.06);
      --shadow-soft:rgba(29,51,62,.08);
      --shadow-medium:rgba(29,51,62,.12);
      --shadow-strong:rgba(29,51,62,.16);
      --forest-green:rgba(30, 86, 49, 1);
      --burnt-orange:rgba(195, 74, 44, 1);
      --deep-violet:rgba(107, 30, 109, 1);
      --charcoal-gray:rgba(46, 46, 46, 1);
      --olive-brown:rgba(110, 78, 30, 1);


      /* Vibrant dot colors */
      --dot-elite:#0F172A; --dot-high:#1E40AF; --dot-active:#3B82F6; --dot-special:#C2B11B;
    }

    html,body{margin:0;padding:0;height:100%;width:100%;overflow:hidden}
    *{box-sizing:border-box}
    body{font-family:'Inter',system-ui,sans-serif;background:var(--cream-bg);color:var(--navy-primary)}

    .map-app{position:relative;width:100vw;height:100vh;background:var(--cream-bg)}
    #map{position:absolute;inset:0;background:var(--cream-bg);z-index:1}

    /* Legend / Stats (theme) */
    .legend{position:fixed;top:90px;right:20px;width:320px;max-width:90vw;background:var(--warm-white);
      border:1px solid var(--border-light);border-radius:16px;padding:24px;
      box-shadow:0 8px 30px var(--shadow-medium);backdrop-filter:saturate(140%) blur(6px);
      z-index:2002;transition:.3s cubic-bezier(.4,0,.2,1);transform:translateX(100%);opacity:0;visibility:hidden;
      max-height:calc(100vh - 120px);overflow-y:auto}
    .legend.show{transform:translateX(0);opacity:1;visibility:visible}
    .legend-toggle{display:block!important;position:fixed;top:20px;right:20px;background:var(--navy-primary);
      color:var(--warm-white);border:none;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:600;font-size:14px;
      box-shadow:0 4px 16px var(--shadow-medium);z-index:2000;transition:.3s;min-width:100px;text-align:center}
    .legend-toggle:hover{background:var(--navy-secondary);transform:translateY(-2px);box-shadow:0 6px 20px var(--shadow-strong)}
    .legend-toggle.active{background:var(--accent-blue)}
    .legend-header{text-align:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--border-light)}
    .legend-title{font-size:18px;font-weight:700;color:var(--navy-primary);margin-bottom:4px;letter-spacing:-.025em}
    .legend-subtitle{font-size:13px;color:var(--light-navy);font-weight:500;letter-spacing:.25px}
    .legend-section{margin-bottom:16px}
    .legend-section-title{font-size:13px;font-weight:600;color:var(--navy-secondary);margin-bottom:10px}
    .legend-item{display:flex;align-items:center;margin-bottom:8px;padding:8px 12px;border-radius:10px;transition:.2s;gap:12px}
    .legend-color{width:24px;height:24px;border-radius:50%;border:2px solid var(--warm-white);box-shadow:0 2px 8px var(--shadow-soft)}
    .legend-color.elite{background:linear-gradient(135deg,var(--dot-elite),#334155)}
    .legend-color.high{background:linear-gradient(135deg,var(--dot-high),#3730A3)}
    .legend-color.active{background:linear-gradient(135deg,var(--dot-active),#2563EB)}
    .legend-color.special{background:linear-gradient(135deg,var(--dot-special),#C2B11B)}
    .legend-text{flex:1;font-size:14px;font-weight:500;color:var(--navy-primary)}
    .legend-count{color:var(--light-navy);font-size:11px;font-weight:600;background:var(--soft-gray);padding:2px 6px;border-radius:10px;min-width:20px;text-align:center}
    .legend-item {
  display: flex;
  align-items: center;
  gap: 12px;
}

.legend-item .popup-program {
  width: 100px; /* ajusta al m√°s largo */
  text-align: center;
}

.legend .program-filter-btn{
  appearance:none;
  border:1px solid rgba(29,51,62,.18);
  cursor:pointer;
}
.legend .program-filter-btn.active{
  box-shadow:0 0 0 3px rgba(43,116,179,.22), 0 4px 14px var(--shadow-medium);
  transform:translateY(-1px);
}



    .stats{position:fixed;bottom:24px;left:24px;background:var(--warm-white);border:1px solid var(--border-light);
      border-radius:16px;padding:16px 20px;box-shadow:0 8px 30px var(--shadow-medium);backdrop-filter:saturate(140%) blur(6px);z-index:1000}
    .stats-title{font-size:13px;font-weight:600;color:var(--navy-secondary);margin-bottom:6px}
    .stats-grid{display:flex;gap:16px}.stat-item{text-align:center}
    .stat-number{font-size:20px;font-weight:700;color:var(--navy-primary);transition:.3s}
    .stat-number:hover{transform:scale(1.05);color:var(--accent-blue)}
    .stat-label{font-size:10px;color:var(--light-navy);font-weight:500;text-transform:uppercase;letter-spacing:.5px}

    /* Map disclaimer */
    .disclaimer-toggle{position:fixed;left:20px;bottom:20px;background:var(--warm-white);color:var(--navy-primary);
      border:1px solid var(--border-light);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:600;font-size:12px;
      box-shadow:0 4px 14px var(--shadow-medium);z-index:1998;transition:.2s}
    .disclaimer-toggle:hover{transform:translateY(-1px);box-shadow:0 6px 18px var(--shadow-strong)}
    .disclaimer-toggle.active{background:var(--navy-primary);color:var(--warm-white)}
    .disclaimer-panel{position:fixed;left:20px;bottom:58px;width:360px;max-width:calc(100vw - 40px);background:var(--warm-white);
      border:1px solid var(--border-light);border-radius:12px;padding:12px 14px;box-shadow:0 8px 24px var(--shadow-medium);
      color:var(--navy-primary);font-size:12px;line-height:1.45;z-index:1999;display:none}
    .disclaimer-panel.show{display:block}
    .disclaimer-panel a{color:var(--accent-blue);text-decoration:underline}

    /* OpenLayers popup styled to theme */
    .ol-popup {
      position: absolute;
      background: var(--warm-white);
      border: 1px solid rgba(30,45,58,0.06);
      border-radius: 12px;
      box-shadow: 0 12px 36px rgba(30, 45, 58, 0.16);
      padding: 14px 16px;
      min-width: 220px;
      z-index: 10000;
      transform: translate(-50%, -100%);
      color: var(--navy-primary);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }
    .popup-title{font-size:16px;font-weight:800;margin-bottom:8px}
    .popup-programs{display:flex;flex-wrap:wrap;gap:3px;margin-top:6px}
    .popup-program{padding:2px 6px;border-radius:10px;font-size:10px;font-weight:600;color:var(--warm-white)}
    .popup-program.star{background:var(--forest-green)} .popup-program.nations{background:var(--burnt-orange)}
    .popup-program.big{background:var(--deep-violet)} .popup-program.excl{background:var(--olive-brown)}
    .big-scholars-section{margin-top:10px;padding-top:8px;border-top:1px solid var(--border-light)}
    .big-scholars-title{font-size:12px;font-weight:600;color:var(--accent-blue);margin-bottom:6px}
    .year-group{margin-bottom:6px}.year-label{font-size:11px;font-weight:700;color:var(--navy-secondary);margin-bottom:3px}
    .scholars-list{display:flex;flex-wrap:wrap;gap:3px;margin-left:6px}
    .scholar-name{background:rgba(59,130,246,.1);color:var(--accent-blue);padding:1px 5px;border-radius:6px;font-size:9px;
      font-weight:500;border:1px solid rgba(59,130,246,.2)}

    /* Hover tooltip */
    .hover-tooltip {
      position: absolute;
      background: var(--warm-white);
      color: var(--navy-primary);
      border: 1px solid rgba(30,45,58,0.06);
      border-radius: 12px;
      box-shadow: 0 12px 36px rgba(30, 45, 58, 0.16);
      padding: 14px 16px;
      min-width: 220px;
      pointer-events: none;
      z-index: 10001;
      white-space: nowrap;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
    }
    .hover-tooltip.above {
      transform: translate(-50%, -100%);
      margin-top: -8px;
    }
    .hover-tooltip.below {
      transform: translate(-50%, 20px);
      margin-top: 8px;
    }
    .hover-tooltip .popup-title {
      font-size: 16px;
      font-weight: 800;
      margin-bottom: 8px;
    }
    .hover-tooltip .popup-programs {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      margin-top: 6px;
    }
    .hover-tooltip .popup-program {
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
      color: var(--warm-white);
    }
    .hover-tooltip .popup-program.star { background: var(--forest-green); }
    .hover-tooltip .popup-program.nations { background: var(--burnt-orange); }
    .hover-tooltip .popup-program.big { background: var(--deep-violet); }
    .hover-tooltip .popup-program.excl { background: var(--olive-brown); }
    .hover-tooltip .big-scholars-section {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--border-light);
      white-space: normal;
    }
    .hover-tooltip .big-scholars-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-blue);
      margin-bottom: 6px;
    }
    .hover-tooltip .year-group {
      margin-bottom: 6px;
    }
    .hover-tooltip .year-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--navy-secondary);
      margin-bottom: 3px;
    }
    .hover-tooltip .scholars-list {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      margin-left: 6px;
    }
    .hover-tooltip .scholar-name {
      background: rgba(59,130,246,.1);
      color: var(--accent-blue);
      padding: 1px 5px;
      border-radius: 6px;
      font-size: 9px;
      font-weight: 500;
      border: 1px solid rgba(59,130,246,.2);
    }
    /* Tooltip interactive only on touch devices (we'll add .touch via JS) */
    .hover-tooltip.touch {
      pointer-events: auto;
    }

    /* "Learn more" button styling */
    .hover-tooltip .tooltip-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    .hover-tooltip .tooltip-learnmore {
      appearance: none;
      border: 1px solid rgba(30,45,58,0.12);
      background: var(--warm-white);
      color: var(--navy-primary);
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
    }

    .country-callout {
      position: absolute;
      display: none;
      min-width: 180px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.96);
      border: 1px solid rgba(29,51,62,.12);
      border-radius: 12px;
      box-shadow: 0 10px 28px rgba(29,51,62,.14);
      color: var(--navy-primary);
      z-index: 1500;
      pointer-events: auto;
    }
    .country-callout::before {
      content: "";
      position: absolute;
      top: 50%;
      left: -34px;
      width: 28px;
      height: 2px;
      background: rgba(44,74,90,.72);
      transform: translateY(-50%);
    }
    .country-callout::after {
      content: "";
      position: absolute;
      top: 50%;
      left: -42px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-blue);
      border: 2px solid var(--warm-white);
      box-shadow: 0 2px 8px rgba(29,51,62,.18);
      transform: translateY(-50%);
    }
    .country-callout-title {
      font-size: 13px;
      font-weight: 800;
      letter-spacing: .02em;
      margin-bottom: 3px;
    }
    .country-callout-copy {
      font-size: 12px;
      line-height: 1.35;
      color: var(--navy-secondary);
    }
    .country-callout.linkable {
      cursor: pointer;
    }
    .country-callout.linkable:hover {
      border-color: rgba(43,116,179,.24);
      box-shadow: 0 12px 32px rgba(29,51,62,.18);
    }


    /* Mobile tweaks */
    @media (max-width:768px){
      .legend{top:85px;right:10px;left:10px;width:auto;max-height:calc(100vh - 110px);overflow:auto}
      .legend.show{transform:translateY(0)}
      .legend-toggle{top:10px;right:10px;padding:10px 14px;font-size:13px}
      .stats{bottom:10px;left:10px;padding:10px 14px}
      .disclaimer-toggle{left:10px;bottom:10px}
      .disclaimer-panel{left:10px;bottom:50px;max-width:calc(100vw - 20px)}
      .stat-number{font-size:18px}
      .country-callout{min-width:150px;padding:8px 10px}
      .country-callout::before{left:-26px;width:20px}
      .country-callout::after{left:-34px}
      .country-callout-title{font-size:12px}
      .country-callout-copy{font-size:11px}
    }
    @media (max-width:480px){
      .legend{width:90vw;top:80px;right:5px;padding:18px;max-height:calc(100vh - 105px)}
      .legend-toggle{font-size:12px;padding:10px 14px}
      .stats{bottom:5px;left:5px;font-size:11px;padding:8px 10px}
      .disclaimer-toggle{left:8px;bottom:8px;padding:7px 10px;font-size:11px}
      .disclaimer-panel{left:8px;bottom:46px;max-width:calc(100vw - 16px);font-size:11px}
      .country-callout{
        min-width:132px;
        padding:7px 9px;
      }
      .country-callout::before{
        left:-22px;
        width:16px;
      }
      .country-callout::after{
        left:-30px;
      }
    }
  </style>
</head>
<body>
  <div class="map-app">
    <div id="map"></div>
    <div id="hkCallout" class="country-callout" aria-hidden="true">
      <div class="country-callout-title">Hong Kong, China</div>
    </div>

    <!-- Popup container for OpenLayers -->
    <div id="popup" class="ol-popup" style="display:none;">
      <div id="popup-content"></div>
    </div>

    <!-- Legend toggle button -->
    <button class="legend-toggle" onclick="toggleLegend()" id="legendToggle">üìä Legend</button>
    <button class="disclaimer-toggle" onclick="toggleDisclaimer()" id="disclaimerToggle">Map disclaimer</button>
    <div class="disclaimer-panel" id="disclaimerPanel">
      Map boundaries are from the
      <a href="https://www.imf.org/external/datamapper/NGDP_RPCH@WEO/OEMDC/ADVEC/WEOWORLD" target="_blank" rel="noopener noreferrer">IMF DataMapper</a>.
      The boundaries do not imply any judgment on the legal status of any territory or any endorsement or acceptance of such boundaries.
    </div>

    <div class="legend" id="legend">
      <div class="legend-header">
        <div class="legend-title">GTF Impact Map</div>
        <!--<div class="legend-subtitle">Winkel Tripel ‚Ä¢ Fair-size compromise</div>-->
      </div>
      

      <div class="legend-section">
        <div class="legend-item">
          <div class="legend-text">
            We've reached students, coaches, and Olympiad organizations in 88 countries.
          </div>
        </div>
      </div>

      <div class="legend-section">
        <div class="legend-section-title">Program Participation</div>

        <div class="legend-item">
          <div class="legend-color elite"></div>
          <div class="legend-text">3+ programs</div>
          <div class="legend-count" id="elite-count">0</div>
        </div>

        <div class="legend-item">
          <div class="legend-color high"></div>
          <div class="legend-text">2 programs</div>
          <div class="legend-count" id="high-count">0</div>
        </div>

        <div class="legend-item">
          <div class="legend-color active"></div>
          <div class="legend-text">1 program</div>
          <div class="legend-count" id="active-count">0</div>
        </div>
      </div>
      <div class ="legend-section">
        <div class ="legend-section-title">Programs:</div>
        <div class ="legend-item">
            <button type="button" class="popup-program big program-filter-btn" data-program="BIG">GTF BIG Talent Scholars</button>
            <div class="legend-text">Scholarships</div>
        </div>
        <div class ="legend-item">
            <button type="button" class="popup-program nations program-filter-btn" data-program="NATIONS">GTF Olympiad Grants</button>
            <div class="legend-text">Grants to organizations</div>
        </div>
        <div class ="legend-item">
            <button type="button" class="popup-program excl program-filter-btn" data-program="EXCL">GTF Coaches</button>
            <div class="legend-text">Training for Olympiad coaches</div>
        </div>
        <div class ="legend-item">
            <button type="button" class="popup-program star program-filter-btn" data-program="STAR">GTF STAR</button>
            <div class="legend-text">Training to high school students</div>
        </div>
      </div>
      <div class="legend-section">
        <div class = "legend-text">Countries and regions with GTF BIG Talent Scholars, GTF Olympiad Grantees, or GTF Coaches profiles have individual pages.</div>
      </div>
    </div>
<script>

      // Load programData.json

      let programData = {}; // se llenar√° desde /data/programData.json

      async function loadProgramData() {
            const res = await fetch("./data/programData.json", { cache: "no-store" });
            if (!res.ok) throw new Error(`Failed to load programData.json (${res.status})`);
            programData = await res.json();
}

      // Country website mappings loaded from Excel for click navigation
      let countryWebsites = {};

      async function loadCountryWebsites() {
            const res = await fetch("./data/country_websites.xlsx", { cache: "no-store" });
            if (!res.ok) throw new Error(`Failed to load country_websites.xlsx (${res.status})`);

            const buffer = await res.arrayBuffer();
            const wb = XLSX.read(buffer, { type: "array" });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

            const parsed = {};
            for (const row of rows) {
                  const country = String(row.country || row.Country || "").trim();
                  const url = String(row.url || row.URL || "").trim();
                  if (country && url) parsed[country] = url;
            }
            countryWebsites = parsed;
      }

    /* Legend toggle */
    function toggleLegend(){
      const legend=document.getElementById('legend');
      const btn=document.getElementById('legendToggle');
      legend.classList.toggle('show');
      btn.classList.toggle('active');
      btn.textContent=legend.classList.contains('show')?'‚úï Close':'üìä Legend';
    }

    function toggleDisclaimer(){
      const panel=document.getElementById('disclaimerPanel');
      const btn=document.getElementById('disclaimerToggle');
      panel.classList.toggle('show');
      btn.classList.toggle('active');
    }
</script>

<script>
  window.addEventListener("load", async () => {

    // Load external data first

    try {
          await Promise.all([
                loadProgramData(),
                loadCountryWebsites(),
          ]);
    } catch (e) {
          console.error(e);
    }

    // -----------------------------
    // 1) Projection (simple + explicit)
    // -----------------------------
    const PROJ_CODE = "CUSTOM:ROBIN";
    proj4.defs(PROJ_CODE, "+proj=robin +datum=WGS84 +units=m +no_defs");
    ol.proj.proj4.register(proj4);

    const WORLD_EXTENT = [-18000000, -8500000, 18000000, 8500000];
    const projection = ol.proj.get(PROJ_CODE);
    projection.setExtent(WORLD_EXTENT);

    // -----------------------------
    // 2) Program labels (single source of truth)
    // -----------------------------
    const PROGRAM_LABELS = {
          BIG: "GTF BIG Talent Scholars",
          NATIONS: "GTF Olympiad Grants",
          EXCL: "GTF Coaches",
          STAR: "GTF STAR",
    };

    const programLabel = (code) => PROGRAM_LABELS[code] || code;

    // -----------------------------
    // 3) Helpers
    // -----------------------------
    function levelFromPrograms(programs) {
          const n = programs.length;
          if (n >= 3) return "elite";
          if (n === 2) return "high";
          if (n === 1) return "active";
          return "special";
    }

    function levelColor(level) {
      switch (level) {
        case "elite": return "#0F172A";
        case "high": return "#1E40AF";
        case "active": return "#3B82F6";
        case "special": return "#C2B11B";
        default: return "#AAB8C2";
      }
    }

    function responsiveViewParams() {
      // Ajusta aqu√≠, pero sin ‚Äúmagia‚Äù extra
      if (window.innerWidth <= 768) {
        return { centerLonLat: [10, 50], zoom: 2.7, padding: [120, 30, 30, 30] };
      }
      return { centerLonLat: [0, 5], zoom: 2.9, padding: [200, 60, 40, 60] };
    }

    function makeTooltipEl() {
      const el = document.createElement("div");
        el.className = "hover-tooltip";
        el.style.display = "none";
        document.body.appendChild(el);
        return el;
    }

    function setTooltipPosition(tooltipEl, mapTargetEl, pixel) {
      const rect = mapTargetEl.getBoundingClientRect();
      const x = rect.left + pixel[0];
      const y = rect.top + pixel[1];

      const isNearTop = y < window.innerHeight * 0.3;

      // Preserve any extra classes (e.g., .touch)
      tooltipEl.classList.add("hover-tooltip");
      tooltipEl.classList.toggle("below", isNearTop);
      tooltipEl.classList.toggle("above", !isNearTop);

      tooltipEl.style.left = x + "px";
      tooltipEl.style.top = y + "px";
    }

    function tooltipHTML(country, programs, bigScholars, opts = {}) {
      const { isTouch = false, url = null } = opts;

      const chips = programs.length
        ? `<div class="popup-programs">${
            programs
              .map((code) => `<span class="popup-program ${code.toLowerCase()}">${programLabel(code)}</span>`)
              .join("")
          }</div>`
        : "";

      const hostLine =
        (country === "United Kingdom" || country === "France")
          ? `<div style="margin-bottom:6px; font-size:13px;">Host country for GTF BIG Talent Scholars</div>`
          : "";

      const bigSection =
        programs.includes("BIG") && bigScholars
          ? `
            <div class="big-scholars-section">
              <div class="big-scholars-title">üéì Scholars by starting year</div>
              ${Object.entries(bigScholars)
                .sort(([a], [b]) => Number(b) - Number(a))
                .map(([year, names]) => `
                  <div class="year-group">
                    <div class="year-label">${year}</div>
                    <div class="scholars-list">
                      ${names.map((n) => `<span class="scholar-name">${n}</span>`).join("")}
                    </div>
                  </div>
                `)
                .join("")}
            </div>`
          : "";

      // Button only if: touch device AND URL exists
      const learnMore =
        isTouch && url
          ? `
            <div class="tooltip-actions">
              <button class="tooltip-learnmore" type="button" data-url="${url}">Learn more</button>
            </div>`
          : "";

      return `
        <div class="popup-title">${country}</div>
        ${hostLine}
        ${chips}
        ${bigSection}
        ${learnMore}
      `;
    }

    // -----------------------------
    // 4) Layers
    // -----------------------------
    const countriesSource = new ol.source.Vector();

    // Hover state
    let hoveredCountryKey = null;
    let selectedProgram = null;

    function hexToRgba(hex, alpha) {
      const h = hex.replace("#", "");
      const r = parseInt(h.slice(0, 2), 16);
      const g = parseInt(h.slice(2, 4), 16);
      const b = parseInt(h.slice(4, 6), 16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    const countriesLayer = new ol.layer.Vector({
      source: countriesSource,
      style: (feature) => {
        const key = feature.get("countryKey");
        const level = feature.get("level"); // "elite" | "high" | "active" | "special" | null
        const programs = feature.get("programs") || [];
        const matchesSelectedProgram = selectedProgram ? programs.includes(selectedProgram) : true;

        // Paises sin datos: casi blanco
        let fillColor = "rgba(255,255,255,0.95)";
        let strokeColor = "#D4D9DE";
        let strokeWidth = 0.6;

        if (level) {
          // Mismo tono de los puntos aplicado al relleno.
          const base = levelColor(level);
          fillColor = hexToRgba(base, 0.85);
          strokeColor = "#FFFFFF";
          strokeWidth = 0.9;
        }

        if (selectedProgram) {
          if (matchesSelectedProgram) {
            fillColor = level ? hexToRgba(levelColor(level), 0.98) : "rgba(190,205,225,0.95)";
            strokeColor = "rgba(70,95,120,0.75)";
            strokeWidth = 1.1;
          } else {
            fillColor = level ? hexToRgba(levelColor(level), 0.22) : "rgba(255,255,255,0.50)";
            strokeColor = "rgba(170,180,190,0.55)";
            strokeWidth = 0.5;
          }
        }

        // Highlight de hover.
        if (key && key === hoveredCountryKey) {
          if (selectedProgram) {
            if (matchesSelectedProgram) {
              strokeColor = "rgba(55,80,105,0.82)";
              strokeWidth = 1.35;
            }
          } else if (level) {
            fillColor = hexToRgba(levelColor(level), 0.97);
          } else {
            fillColor = "rgba(210,220,235,0.95)";
          }
        }

        return new ol.style.Style({
          fill: new ol.style.Fill({ color: fillColor }),
          stroke: new ol.style.Stroke({ color: strokeColor, width: strokeWidth }),
        });
      },
    });


    // -----------------------------
    // 5) Map init
    // -----------------------------
    const { centerLonLat, zoom, padding } = responsiveViewParams();
    const center = ol.proj.transform(centerLonLat, "EPSG:4326", PROJ_CODE);

    const map = new ol.Map({
      target: "map",
      layers: [countriesLayer],
      view: new ol.View({
        projection,
        center,
        zoom,
        minZoom: 2.2,
        maxZoom: 6.0,
        extent: WORLD_EXTENT,
      }),
    });

    map.getView().fit(WORLD_EXTENT, {
      size: map.getSize(),
      padding,
      maxZoom: 3.2,
    });

    // -----------------------------
// 6) Load boundaries once (geometry.json + country_codes.json)
// -----------------------------
Promise.all([
  fetch("./data/country_codes.json").then((r) => r.json()),
  fetch("./data/geometry.json").then((r) => r.json()),
])
  .then(([codesJson, geomJson]) => {
    // country_codes.json: { countries: { USA: {label:"United States"}, ... } }
    const countriesDict = codesJson.countries || {};
    const isoToLabel = {};
    for (const [iso3, obj] of Object.entries(countriesDict)) {
      if (obj && typeof obj.label === "string" && obj.label.trim()) {
        isoToLabel[iso3] = obj.label.trim();
      }
    }
    // geometry.json:
    // items: { USA: { m:[20,21,...], b:[...] }, ... }
    // masses: { "20": { poly:[[lon,lat],...], scale:"1" }, ... }
    const items = geomJson.items || {};
    const masses = geomJson.masses || {};

    // ---- geometry.json est√° normalizado (x‚âà[0..200], y‚âà[0..109.678]) y Y crece hacia abajo.
    // Calculamos bbox real desde masses para mapearlo a WORLD_EXTENT (Robinson metros).
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

    for (const m of Object.values(masses)) {
      const poly = m?.poly;
      if (!Array.isArray(poly)) continue;
      for (const pt of poly) {
        const x = pt[0], y = pt[1];
        if (x < minX) minX = x;
        if (x > maxX) maxX = x;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      }
    }

    // Mapeo af√≠n: geometry.json -> WORLD_EXTENT (Robinson metros)
    const [wx0, wy0, wx1, wy1] = WORLD_EXTENT;
    const scaleX = (wx1 - wx0) / (maxX - minX);
    const scaleY = (wy1 - wy0) / (maxY - minY);

    // Convierte un punto [x,y] del geometry.json a [X,Y] en PROJ_CODE.
    // Nota: invertimos Y porque geometry.json tiene Y hacia abajo.
    function geomToRobin([x, y]) {
      const X = wx0 + (x - minX) * scaleX;
      const Y = wy1 - (y - minY) * scaleY; // flip vertical
      return [X, Y];
    }

    // Asegura que el anillo est√© cerrado (primer punto = √∫ltimo)
    function closeRing(ring) {
      if (!ring.length) return ring;
      const [x0, y0] = ring[0];
      const [xN, yN] = ring[ring.length - 1];
      if (x0 !== xN || y0 !== yN) ring.push([x0, y0]);
      return ring;
    }

    const feats = [];

    for (const [iso3, entry] of Object.entries(items)) {
      const labelRaw = isoToLabel[iso3] || iso3;
      const countryKey = labelRaw;

      const mList = Array.isArray(entry?.m) ? entry.m : [];
      if (!mList.length) continue;

      // Construimos un MultiPolygon: cada "mass" es un pol√≠gono (anillo exterior)
      const multi = [];

      for (const massId of mList) {
        const mass = masses[String(massId)];
        const poly = mass?.poly;
        if (!Array.isArray(poly) || poly.length < 3) continue;

        const ring = poly.map(geomToRobin);
        closeRing(ring);
        multi.push([ring]);
      }

      if (!multi.length) continue;

      const geom = new ol.geom.MultiPolygon(multi); // ya est√° en PROJ_CODE

      const f = new ol.Feature({ geometry: geom });

      // Enlaza el pa√≠s con programData (tu l√≥gica existente)
      f.set("countryKey", countryKey);

      const d = programData[countryKey];
      if (d) {
        const programs = d.programs || [];
        f.set("programs", programs);
        f.set("bigScholars", d.bigScholars || null);
        f.set("level", levelFromPrograms(programs));
      } else {
        f.set("programs", []);
        f.set("bigScholars", null);
        f.set("level", null);
      }

      feats.push(f);
    }

    countriesSource.addFeatures(feats);

    // Re-fit cuando ya existen pol√≠gonos (para asegurar centrado correcto)
    const countriesExtent = countriesSource.getExtent();
    const fitExtent = (countriesExtent && !ol.extent.isEmpty(countriesExtent)) ? countriesExtent : WORLD_EXTENT;
    map.getView().fit(fitExtent, {
      size: map.getSize(),
      padding,
      maxZoom: 3.8,
    });

    renderHongKongCallout();
  })
  .catch((err) => console.error("Error loading geometry/codes:", err));

    // 7) Interactions: hover tooltip + highlight, click open website
    const tooltipEl = makeTooltipEl();
    const mapTargetEl = map.getTargetElement();
    const hkCalloutEl = document.getElementById("hkCallout");
    const programFilterButtons = Array.from(document.querySelectorAll(".program-filter-btn"));
    const HONG_KONG_KEY = "Hong Kong, China";

    const isTouchDevice =
      window.matchMedia?.("(pointer: coarse)")?.matches ||
      "ontouchstart" in window ||
      (navigator.maxTouchPoints || 0) > 0;

    function hideTooltip() {
      tooltipEl.style.display = "none";
    }

    function renderHongKongCallout() {
      if (!hkCalloutEl) return;

      const hongKongFeature = countriesSource
        .getFeatures()
        .find((feature) => feature.get("countryKey") === HONG_KONG_KEY);

      if (!hongKongFeature) {
        hkCalloutEl.style.display = "none";
        return;
      }

      const geometry = hongKongFeature.getGeometry();
      if (!geometry) {
        hkCalloutEl.style.display = "none";
        return;
      }

      const anchorCoordinate = ol.extent.getCenter(geometry.getExtent());
      const anchorPixel = map.getPixelFromCoordinate(anchorCoordinate);

      if (!anchorPixel || !Number.isFinite(anchorPixel[0]) || !Number.isFinite(anchorPixel[1])) {
        hkCalloutEl.style.display = "none";
        return;
      }

      const calloutOffsetX = window.innerWidth <= 768 ? 28 : 42;
      const calloutOffsetY = window.innerWidth <= 768 ? -20 : -28;

      hkCalloutEl.style.left = `${anchorPixel[0] + calloutOffsetX}px`;
      hkCalloutEl.style.top = `${anchorPixel[1] + calloutOffsetY}px`;
      hkCalloutEl.style.display = "block";
      hkCalloutEl.classList.toggle("linkable", Boolean(countryWebsites[HONG_KONG_KEY]));
    }

    function refreshProgramFilterUI() {
      for (const btn of programFilterButtons) {
        btn.classList.toggle("active", btn.dataset.program === selectedProgram);
      }
      countriesLayer.changed();
    }

    function clearProgramFilter() {
      if (!selectedProgram) return false;
      selectedProgram = null;
      hoveredCountryKey = null;
      hideTooltip();
      mapTargetEl.style.cursor = "";
      refreshProgramFilterUI();
      return true;
    }

    for (const btn of programFilterButtons) {
      btn.addEventListener("click", (evt) => {
        evt.preventDefault();
        evt.stopPropagation();
        const programCode = btn.dataset.program || null;
        selectedProgram = selectedProgram === programCode ? null : programCode;
        hoveredCountryKey = null;
        hideTooltip();
        mapTargetEl.style.cursor = "";
        refreshProgramFilterUI();
      });
    }

    if (hkCalloutEl) {
      hkCalloutEl.addEventListener("click", (evt) => {
        evt.preventDefault();
        evt.stopPropagation();
        const url = countryWebsites[HONG_KONG_KEY];
        if (url) window.open(url, "_blank");
      });
    }

    // Make tooltip interactive only on touch devices (so the button works)
    if (isTouchDevice) {
      tooltipEl.classList.add("touch");

      // Event delegation for Learn more button
      tooltipEl.addEventListener("click", (e) => {
        const btn = e.target.closest(".tooltip-learnmore");
        if (!btn) return;
        const url = btn.getAttribute("data-url");
        if (url) window.open(url, "_blank");
        e.stopPropagation();
      });
    }

    map.on("movestart", () => {
      hideTooltip();
    });

    map.on("moveend", () => {
      renderHongKongCallout();
    });

    map.on("singleclick", (evt) => {
      if (clearProgramFilter()) return;

      const feat = map.forEachFeatureAtPixel(evt.pixel, (f, layer) =>
        layer === countriesLayer ? f : null
      );
      if (!feat) return;

      const country = feat.get("countryKey");
      const programs = feat.get("programs") || [];
      const bigScholars = feat.get("bigScholars");
      const url = countryWebsites[country] || null;

      // Touch: tap shows tooltip (no accidental activation during pan, since pointermove is disabled)
      if (isTouchDevice) {
        // Optional: mimic your desktop rule (only show tooltip if it has data)
        if (!programs.length) {
          hideTooltip();
          return;
        }

        hoveredCountryKey = country;
        countriesLayer.changed();

        tooltipEl.innerHTML = tooltipHTML(country, programs, bigScholars, {
          isTouch: true,
          url,
        });
        tooltipEl.style.display = "block";
        setTooltipPosition(tooltipEl, mapTargetEl, evt.pixel);
        return;
      }

      // Desktop: keep current behavior (open link if exists)
      if (url) window.open(url, "_blank");
    });


    map.on("pointermove", (evt) => {
      
      if (isTouchDevice) return;

      const feat = map.forEachFeatureAtPixel(evt.pixel, (f, layer) =>
        layer === countriesLayer ? f : null
      );

      if (!feat) {
        mapTargetEl.style.cursor = "";
        tooltipEl.style.display = "none";
        if (hoveredCountryKey !== null) {
          hoveredCountryKey = null;
          countriesLayer.changed();
        }
        return;
      }

      const country = feat.get("countryKey");
      const programs = feat.get("programs") || [];
      const bigScholars = feat.get("bigScholars");

      mapTargetEl.style.cursor = programs.length ? "pointer" : "";

      // highlight
      if (hoveredCountryKey !== country) {
        hoveredCountryKey = country;
        countriesLayer.changed(); // fuerza re-render del estilo
      }

      // tooltip (solo si tiene programas; si lo quieres siempre, quita este if)
      if (!programs.length) {
        tooltipEl.style.display = "none";
        return;
      }

      tooltipEl.innerHTML = tooltipHTML(country, programs, bigScholars);
      tooltipEl.style.display = "block";
      setTooltipPosition(tooltipEl, mapTargetEl, evt.pixel);
    });

    // -----------------------------
    // 8) Stats (single pass, no extra objects)
    // -----------------------------
    (function updateStats() {
      let elite = 0, high = 0, active = 0;

      for (const d of Object.values(programData)) {
        const n = (d.programs || []).length;
        if (n >= 3) elite++;
        else if (n === 2) high++;
        else if (n === 1) active++;
      }

      document.getElementById("elite-count").textContent = elite;
      document.getElementById("high-count").textContent = high;
      document.getElementById("active-count").textContent = active;
      const totalCountriesEl = document.getElementById("total-countries");
      if (totalCountriesEl) totalCountriesEl.textContent = Object.keys(programData).length;
    })();

    // Keep legend toggle above map
    const toggleBtn = document.getElementById("legendToggle");
    if (toggleBtn) toggleBtn.style.zIndex = "2001";

    renderHongKongCallout();
    window.addEventListener("resize", renderHongKongCallout);
  });
</script>

</body>
</html>
